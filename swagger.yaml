openapi: 3.0.3
info:
  title: Loyalty API
  version: 1.0.0
  description: QR-based loyalty system with events, redemptions, KYC
servers:
  - url: http://localhost:3000/api/v1
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Error:
      type: object
      properties:
        success: { type: boolean, example: false }
        error: { type: object, properties: { message: { type: string }, correlationId: { type: string } } }
        code: { type: integer }
    ScanRequest:
      type: object
      required: [qrCode, latitude, longitude]
      properties:
        qrCode: { type: string, maxLength: 255 }
        latitude: { type: number, minimum: -90, maximum: 90 }
        longitude: { type: number, minimum: -180, maximum: 180 }
        metadata: { type: object }
    ScanResponse:
      type: object
      properties:
        success: { type: boolean }
        data: { type: object, properties: { points: { type: number }, message: { type: string } } }
        correlationId: { type: string }
    RegisterRequest:
      type: object
      required: [phone, password, name]
      properties:
        phone: { type: string, example: '9888888888' }
        password: { type: string, format: password }
        name: { type: string }
        email: { type: string, format: email }
        onboardingTypeId: { type: integer }
        roleId: { type: integer }
    UserSummary:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        phone: { type: string }
        email: { type: string }
    AuthResponse:
      type: object
      properties:
        success: { type: boolean, example: true }
        data:
          type: object
          properties:
            accessToken: { type: string }
            refreshToken: { type: string }
            user: { $ref: '#/components/schemas/UserSummary' }
        correlationId: { type: string }
    SimpleType:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        description: { type: string }
        isActive: { type: boolean }
    RedemptionTypesResponse:
      type: object
      properties:
        success: { type: boolean }
        data:
          type: object
          properties:
            channels:
              type: array
              items:
                $ref: '#/components/schemas/SimpleType'
            statuses:
              type: array
              items:
                $ref: '#/components/schemas/SimpleType'
        correlationId: { type: string }
    TicketTypesResponse:
      type: object
      properties:
        success: { type: boolean }
        data:
          type: object
          properties:
            types:
              type: array
              items:
                $ref: '#/components/schemas/SimpleType'
            statuses:
              type: array
              items:
                $ref: '#/components/schemas/SimpleType'
        correlationId: { type: string }
paths:
  # Auth
  /auth/login:
    post:
      summary: User login
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                phone: { type: string }
                password: { type: string }
      responses:
        '200': { description: Login success }
        '401': { description: Invalid credentials }
  /auth/register:
    post:
      summary: User registration
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Registration success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /auth/login/password:
    post:
      summary: Login with password
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                phone: { type: string }
                password: { type: string }
      responses:
        '200': { description: Login success }
        '401': { description: Invalid credentials }
  /auth/login/otp:
    post:
      summary: Login with OTP
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                phone: { type: string }
                otp: { type: string }
      responses:
        '200': { description: Login success }
        '401': { description: Invalid OTP }
  /auth/otp/send:
    post:
      summary: Send OTP (login/reset)
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                phone: { type: string }
                channel: { type: string, enum: [sms, email] }
                purpose: { type: string, enum: [login, reset], default: login }
      responses:
        '200': { description: OTP sent }
  /auth/otp/verify:
    post:
      summary: Verify OTP
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                phone: { type: string }
                otp: { type: string }
                purpose: { type: string, enum: [login, reset], default: login }
      responses:
        '200': { description: OTP valid }
        '401': { description: Invalid OTP }
  /auth/reset/request:
    post:
      summary: Request password reset (send OTP)
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                phone: { type: string }
                channel: { type: string, enum: [sms, email] }
      responses:
        '200': { description: OTP sent }
  /auth/reset/confirm:
    post:
      summary: Confirm password reset (verify OTP)
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                phone: { type: string }
                otp: { type: string }
                newPassword: { type: string }
      responses:
        '200': { description: Password reset }
        '401': { description: Invalid OTP or phone }
  /users/profile:
    get:
      summary: Get user profile
      tags: [Users]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: User profile }
    put:
      summary: Update user profile
      tags: [Users]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                email: { type: string }
                phone: { type: string }
      responses:
        '200': { description: Profile updated }
  /transactions/scan:
    post:
      summary: Scan QR Code
      tags: [Transactions]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ScanRequest' }
      responses:
        '200': { description: Success, content: { application/json: { schema: { $ref: '#/components/schemas/ScanResponse' } } } }
        '400': { description: Bad Request, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '401': { description: Unauthorized, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }


 
  # Creative
  /creatives:
    get:
      summary: List creatives
      tags: [Creatives]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: List of creatives }

  # Earning
  /earning/scan:
    post:
      summary: Scan QR for earning
      tags: [Earning]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                qrCode: { type: string }
      responses:
        '200': { description: Points earned }
  /earning/history:
    get:
      summary: Get user's earning history
      tags: [Earning]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 20 }
        - in: query
          name: userType
          schema: { type: string, enum: [electrician, retailer, counter_sales], default: counter_sales }
      responses:
        '200': { description: History list }
  /earning/history/{id}:
    get:
      summary: Get details of an earning transaction
      tags: [Earning]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - in: query
          name: userType
          schema: { type: string, enum: [electrician, retailer, counter_sales], default: counter_sales }
      responses:
        '200': { description: Earning details }
  /earning/passbook:
    get:
      summary: Get user's passbook
      tags: [Earning]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: Passbook details }

    /redemptions/types:
      get:
        summary: Get redemption channels and statuses
        tags: [Redemptions]
        responses:
          '200':
            description: Redemption types
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/RedemptionTypesResponse'


 
 
  # Redemption
  /redemptions:
    post:
      summary: Request redemption
      tags: [Redemptions]
      requestBody:
        required: true
        content:
          application/json:
            schema: { type: object }
      responses:
        '200': { description: Redemption requested }
  /redemptions/request:
    post:
      summary: Request redemption (alias)
      tags: [Redemptions]
      requestBody:
        required: true
        content:
          application/json:
            schema: { type: object }
      responses:
        '200': { description: Redemption requested }
  /redemptions/history:
    get:
      summary: Get redemption history
      tags: [Redemptions]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: History list }
  /redemptions/stats:
    get:
      summary: Get redemption stats
      tags: [Redemptions]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: Stats }
  /redemptions/{id}:
    get:
      summary: Get redemption detail
      tags: [Redemptions]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: Detail }

  # Ticket
  /tickets:
    post:
      summary: Create ticket
      tags: [Tickets]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { type: object }
      responses:
        '201': { description: Ticket created }
    get:
      summary: List tickets
      tags: [Tickets]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: Tickets list }
  /tickets/types:
    get:
      summary: Get ticket types and statuses
      tags: [Tickets]
      responses:
        '200':
          description: Ticket types
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketTypesResponse'
  /tickets/{id}:
    patch:
      summary: Update ticket
      tags: [Tickets]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { type: object }
      responses:
        '200': { description: Ticket updated }

  # Users
  /users/kyc/approve:
    post:
      summary: Approve KYC (user)
      tags: [Users]
      requestBody:
        required: true
        content:
          application/json:
            schema: { type: object }
      responses:
        '200': { description: KYC approved }
  /users/referrals/history:
    get:
      summary: Get user's referral history
      tags: [Users]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: History list }
  # KYC
  /kyc/submit:
    post:
      summary: Submit KYC document for verification
      tags: [KYC]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [documentType, documentValue]
              properties:
                documentType: { type: string, enum: [AADHAR, PAN, GST] }
                documentValue: { type: string }
      responses:
        '200': { description: Document submitted and verified }
        '400': { description: Invalid request or document already pending }
  /kyc/status:
    get:
      summary: Get KYC verification status
      tags: [KYC]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: KYC status with all documents }
  /kyc/documents/{documentType}:
    get:
      summary: Get specific document details
      tags: [KYC]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: documentType
          required: true
          schema: { type: string, enum: [AADHAR, PAN, GST] }
      responses:
        '200': { description: Document details }
        '404': { description: Document not found }
    put:
      summary: Resubmit document for verification
      tags: [KYC]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: documentType
          required: true
          schema: { type: string, enum: [AADHAR, PAN, GST] }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [documentValue]
              properties:
                documentValue: { type: string }
      responses:
        '200': { description: Document resubmitted }
        '400': { description: Cannot resubmit at this time }
  /kyc/history:
    get:
      summary: Get KYC submission history
      tags: [KYC]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 20 }
      responses:
        '200': { description: KYC history with pagination }

  # TDS
  /tds/summary:
    get:
      summary: Get current user's TDS summary
      tags: [TDS]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: Success }
  /tds/history:
    get:
      summary: Get full TDS audit trail for current user
      tags: [TDS]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: Success }

    